<h2 mat-dialog-title>Chỉnh sửa bài đăng</h2>
<mat-dialog-content class="dialog-content">
  <form [formGroup]="editForm">
    <mat-form-field appearance="fill" class="full-width post-content-field">
      <mat-label>Nội dung bài đăng</mat-label>
      <textarea matInput formControlName="content" rows="5" cols="100"></textarea>
    </mat-form-field>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Địa điểm</mat-label>
      <mat-icon matPrefix>location_on</mat-icon>
      <input matInput formControlName="location">
    </mat-form-field>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Quyền riêng tư</mat-label>
      <mat-select formControlName="privacy">
        <mat-option value="PUBLIC">Công khai</mat-option>
        <mat-option value="PRIVATE">Chỉ mình tôi (có thể chia sẻ)</mat-option>
      </mat-select>
      <mat-error *ngIf="editForm.get('privacy')?.hasError('required') && editForm.get('privacy')?.touched">
        Vui lòng chọn quyền riêng tư.
      </mat-error>
    </mat-form-field>

    <div *ngIf="editForm.get('privacy')?.value === 'PRIVATE'" class="form-group">
      <mat-label>Chia sẻ với:</mat-label>
      <mat-chip-listbox aria-label="Người dùng được phép xem" class="mb-2">
        <mat-chip *ngFor="let user of selectedAllowedUsers" (removed)="removeAllowedUser(user)">
          {{user.name}}
          <button matChipRemove [attr.aria-label]="'remove ' + user.name">
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip>
      </mat-chip-listbox>
      <button mat-stroked-button color="primary" type="button" (click)="openUserSelectionDialog()">
        <mat-icon>person_add</mat-icon> Chọn người dùng
      </button>
      <mat-error *ngIf="editForm.get('allowedUserIds')?.hasError('required') && editForm.get('allowedUserIds')?.touched">
        Vui lòng chọn ít nhất một người dùng khi chọn "Chỉ mình tôi".
      </mat-error>
    </div>

    <div *ngIf="data.post.imageUrls?.length || data.post.videoUrls?.length || data.post.audioUrls?.length" class="existing-media-preview">
      <h3>Media hiện có:</h3>
      <div *ngIf="data.post.imageUrls?.length" class="media-list">
        <span *ngFor="let url of data.post.imageUrls" class="media-item">
          <mat-icon>image</mat-icon> Ảnh
          </span>
      </div>
      <div *ngIf="data.post.videoUrls?.length" class="media-list">
        <span *ngFor="let url of data.post.videoUrls" class="media-item">
          <mat-icon>videocam</mat-icon> Video
          </span>
      </div>
      <div *ngIf="data.post.audioUrls?.length" class="media-list">
        <span *ngFor="let url of data.post.audioUrls" class="media-item">
          <mat-icon>mic</mat-icon> Audio
          </span>
      </div>
      <p class="text-sm text-gray-500 mt-2">
        (Chức năng xóa hoặc thay thế media hiện có trực tiếp trong dialog này phức tạp hơn. Bạn có thể cân nhắc xóa bài đăng và tạo lại nếu cần thay đổi media hiện có.)
      </p>
    </div>

    <div class="add-to-post-section">
      <span>Thêm media mới (sẽ được thêm vào bài đăng hiện có)</span>
      <div class="media-upload-buttons">
        <input
          type="file"
          #imageInput
          hidden
          accept="image/*"
          multiple (change)="onFileSelected($event, 'images')"
          (keydown.enter)="$event.preventDefault()" (keydown.space)="$event.preventDefault()">
        <button mat-icon-button (click)="imageInput.click()" class="media-button photo-button" type="button">
          <mat-icon>photo_library</mat-icon>
        </button>

        <input
          type="file"
          #videoInput
          hidden
          accept="video/*"
          multiple (change)="onFileSelected($event, 'videos')"
          (keydown.enter)="$event.preventDefault()" (keydown.space)="$event.preventDefault()">
        <button mat-icon-button (click)="videoInput.click()" class="media-button video-button" type="button">
          <mat-icon>videocam</mat-icon>
        </button>

        <input
          type="file"
          #audioInput
          hidden
          accept="audio/*"
          multiple (change)="onFileSelected($event, 'audios')"
          (keydown.enter)="$event.preventDefault()" (keydown.space)="$event.preventDefault()">
        <button mat-icon-button (click)="audioInput.click()" class="media-button audio-button" type="button">
          <mat-icon>audiotrack</mat-icon>
        </button>
      </div>
    </div>

    <div *ngIf="selectedNewImages.length > 0 || selectedNewVideos.length > 0 || selectedNewAudios.length > 0" class="file-list-preview">
      <h3>Media mới sẽ thêm:</h3>
      <div *ngFor="let file of selectedNewImages; let i = index" class="file-item">
        <mat-icon>image</mat-icon> {{ file.name }}
        <button mat-icon-button (click)="removeSelectedNewFile(i, 'images')" color="warn" type="button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div *ngFor="let file of selectedNewVideos; let i = index" class="file-item">
        <mat-icon>videocam</mat-icon> {{ file.name }}
        <button mat-icon-button (click)="removeSelectedNewFile(i, 'videos')" color="warn" type="button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div *ngFor="let file of selectedNewAudios; let i = index" class="file-item">
        <mat-icon>mic</mat-icon> {{ file.name }}
        <button mat-icon-button (click)="removeSelectedNewFile(i, 'audios')" color="warn" type="button">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

  </form>
</mat-dialog-content>
<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Hủy</button>
  <button mat-flat-button color="primary" (click)="onSave()" [disabled]="editForm.invalid">Lưu</button>
</mat-dialog-actions>
